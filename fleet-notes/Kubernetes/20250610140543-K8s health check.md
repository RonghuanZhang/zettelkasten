---
"type:": fleet-note
"title:": 20250610140543-K8s health check
"id:": 20250610140555
"created:": 2025-06-10T14:05:55
url: 
tags:
  - fleet-note
  - kubernetes
  - kubernetes/resource/deployment
"processed:": false
"archived:": false
---

# `/healthz` å’Œ `/health` æ¥å£çš„åŒºåˆ«

è¿™ä¸¤ä¸ªæ¥å£ `/healthz` å’Œ `/health` **åŠŸèƒ½ç›¸ä¼¼ä½†è¯­ä¹‰ç•¥æœ‰ä¸åŒ**ï¼Œå¸¸è§äº Kubernetes ä¸ Web æœåŠ¡ä¸­å¥åº·æ£€æŸ¥æœºåˆ¶çš„çº¦å®šã€‚

---

## âœ… æ ¸å¿ƒåŒºåˆ«æ€»ç»“

| æ¥å£         | ç”¨é€”/çº¦å®š                                | å¸¸è§äº        | æ¨èç”¨æ³•           |
| ---------- | ------------------------------------ | ---------- | -------------- |
| `/health`  | é€šç”¨å¥åº·æ£€æŸ¥ï¼ˆreadiness/liveness éƒ½å¯èƒ½ï¼‰       | å¸¸è§„æœåŠ¡ã€è´Ÿè½½å‡è¡¡å™¨ | é€šå¸¸è¡¨ç¤ºæ•´ä¸ªæœåŠ¡æ˜¯å¦â€œå¥åº·â€ |
| `/healthz` | Kubernetes ç¤¾åŒºä¼ ç»Ÿç”¨äº **Liveness Probe** | Kubernetes | è¡¨ç¤ºæœåŠ¡æ˜¯å¦â€œå­˜æ´»â€     |

---

## ğŸ” è¯¦ç»†è§£é‡Š

### ğŸ”¸ `/health`

* æ„ä¹‰é€šç”¨ï¼Œ**æ£€æŸ¥æœåŠ¡æ˜¯å¦å¥åº·ã€å¯æ¥å—è¯·æ±‚**
* å¯æ‰©å±•ä¸ºï¼š

  * `GET /health` è¿”å› HTTP 200 è¡¨ç¤ºæœåŠ¡å¥åº·
  * `GET /health?check=db,redis` è¡¨ç¤ºæ£€æŸ¥ç‰¹å®šå­ç³»ç»Ÿ
* å¸¸ç”¨ä½œï¼š

  * LoadBalancer/Ingress çš„å¥åº·æ£€æŸ¥
  * è‡ªå®šä¹‰ health APIï¼ˆå¦‚åŒ…å«æ•°æ®åº“ã€ç¼“å­˜è¿æ¥çŠ¶æ€ç­‰ï¼‰

**ç¤ºä¾‹å“åº”ï¼š**

```json
{
  "status": "ok",
  "db": "ok",
  "redis": "ok"
}
```

---

### ğŸ”¸ `/healthz`

* æœ€åˆç”± Kubernetes ç¤¾åŒºå¼•å…¥ï¼Œ`z` æ²¡æœ‰ç‰¹åˆ«æ„ä¹‰ï¼Œä»…è¡¨ç¤ºâ€œå†…éƒ¨ä¿ç•™â€æˆ–â€œåŒºåˆ«ç”¨é€”â€
* **å¸¸ç”¨ä½œ Liveness Probe**ï¼Œå³â€œæœåŠ¡æ˜¯å¦æ´»ç€ï¼Œä¸æŒ‚â€
* é€šå¸¸åªè¿”å› 200 æˆ– 500ï¼Œä¸åšå¤æ‚é€»è¾‘ï¼ˆä¸èƒ½æ£€æŸ¥ DBï¼Œé¿å…å½±å“ä¸»ç¨‹åºï¼‰
* ç¤ºä¾‹ç”¨æ³•ï¼ˆK8s ä¸­ï¼‰ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8081
  initialDelaySeconds: 5
  periodSeconds: 10
```

---

## âœ… å®è·µå»ºè®®ï¼ˆæ¨èæ­é…ï¼‰

å¦‚æœä½ æ˜¯ Web æœåŠ¡æˆ– K8s ç¯å¢ƒï¼Œæ¨èæä¾›ä¸¤ä¸ªæ¥å£ï¼š

| æ¥å£                    | æè¿°                     | ç”¨äº                              |
| --------------------- | ---------------------- | ------------------------------- |
| `/healthz`            | ç®€å•è¿”å› 200ï¼Œè¡¨ç¤ºæœåŠ¡æ´»ç€        | Kubernetes Liveness Probe       |
| `/readyz` æˆ– `/health` | æ£€æŸ¥æœåŠ¡ä¾èµ–æ˜¯å¦å‡†å¤‡å¥½ï¼ˆæ•°æ®åº“ã€Redisï¼‰ | Kubernetes Readiness Probe æˆ– LB |

---

## âœï¸ ç¤ºä¾‹ Gin å®ç°ï¼ˆä¸¤è€…éƒ½æä¾›ï¼‰

```go
r.GET("/healthz", func(c *gin.Context) {
	c.String(http.StatusOK, "ok")
})

r.GET("/health", func(c *gin.Context) {
	// è¿™é‡Œå¯ä»¥åšå¤æ‚æ£€æŸ¥ï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥ã€Redis ping ç­‰
	status := map[string]string{
		"status": "ok",
		"db":     "ok",
		"redis":  "ok",
	}
	c.JSON(http.StatusOK, status)
})
```

---

å¦‚æœä½ æ‰“ç®—éƒ¨ç½²åœ¨ Kubernetes ä¸­ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ å†™å¥½ `livenessProbe` å’Œ `readinessProbe` çš„é…ç½®ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ


# æ¢æ´»

éå¸¸å¥½çš„é—®é¢˜ï¼ŒErpangï¼è¿™ä¸‰ä¸ªæ¢é’ˆï¼ˆ`livenessProbe`ã€`readinessProbe` å’Œ `startupProbe`ï¼‰æ˜¯ Kubernetes ä¸­éå¸¸å…³é”®çš„**å®¹å™¨å¥åº·ç®¡ç†æœºåˆ¶**ï¼Œå„è‡ªä½œç”¨ä¸åŒã€ç”¨é€”ä¸åŒã€é€‚ç”¨åœºæ™¯ä¹Ÿä¸åŒã€‚ä¸‹é¢æ˜¯è¯¦ç»†å¯¹æ¯”è§£é‡Šï¼š

---

## ğŸ” ä¸‰ç§æ¢é’ˆçš„å¯¹æ¯”ä¸åŒºåˆ«

| æ¢é’ˆç±»å‹             | ä½œç”¨                                | è§¦å‘ç»“æœ                    | æ¨èä½¿ç”¨åœºæ™¯               |
| ---------------- | --------------------------------- | ----------------------- | -------------------- |
| `livenessProbe`  | æ£€æŸ¥å®¹å™¨æ˜¯å¦â€œ**æ´»ç€**â€ï¼Œå³æœ‰æ²¡æœ‰æŒ‚/å¡æ­»           | **å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯å®¹å™¨**           | åº”ç”¨å¯èƒ½å‡ºç°å¡æ­»ã€æ­»å¾ªç¯ç­‰é—®é¢˜æ—¶     |
| `readinessProbe` | æ£€æŸ¥å®¹å™¨æ˜¯å¦â€œ**å°±ç»ª**â€æ¥æ”¶æµé‡                | **å¤±è´¥æ—¶ä¼šä» Service ä¸­æ‘˜é™¤æµé‡** | åº”ç”¨å¯åŠ¨ä¸­ã€åŠ è½½æ•°æ®ä¸­ã€çƒ­èº«æœŸé—´     |
| `startupProbe`   | æ£€æŸ¥å®¹å™¨æ˜¯å¦â€œ**æ­£åœ¨æ­£å¸¸å¯åŠ¨**â€<br>ï¼ˆå¯åŠ¨æ—¶é—´è¾ƒé•¿æ—¶ä½¿ç”¨ï¼‰ | åœ¨å…¶å¤±è´¥å‰**æš‚åœå…¶ä»–æ¢é’ˆçš„æ£€æŸ¥**      | åº”ç”¨å¯åŠ¨éå¸¸æ…¢ï¼Œé˜²æ­¢ K8s è¯¯åˆ¤ä¸ºæŒ‚æ‰ |

---

## ğŸ§  ç”¨ä¸€å¥è¯è®°ä½å®ƒä»¬

* **`liveness` æ˜¯ä½ è¿˜æ´»ç€å—ï¼Ÿ**
* **`readiness` æ˜¯ä½ èƒ½æ¥è¯·æ±‚äº†å—ï¼Ÿ**
* **`startup` æ˜¯ä½ è¿˜åœ¨åŠªåŠ›å¯åŠ¨å—ï¼Ÿ**

---

## ğŸ”§ åœºæ™¯ç¤ºä¾‹

### âœ… å¸¸è§„å¾®æœåŠ¡ï¼ˆå¯åŠ¨å¿«ï¼Œå¯åŠ¨æˆåŠŸå³å°±ç»ªï¼‰

```yaml
# é€‚ç”¨ï¼šGo / Gin / Node.js / å¿«å¯åŠ¨å¾®æœåŠ¡
readinessProbe  âœ…
livenessProbe   âœ…
startupProbe    âŒ ä¸éœ€è¦
```

---

### âœ… Java å¾®æœåŠ¡ / å¯åŠ¨æ…¢çš„æœåŠ¡

```yaml
# é€‚ç”¨ï¼šSpring Bootã€æŸäº› AI æœåŠ¡
startupProbe    âœ… ç”¨äºè¦†ç›–å‰æœŸçš„â€œå‡æ­»â€
readinessProbe  âœ… ä¿è¯çƒ­èº«/ç¼“å­˜åŠ è½½å®Œæˆåæ‰æ¥æµé‡
livenessProbe   âœ… è¿è¡Œä¸­å¼‚å¸¸ä¼šé‡å¯
```

---

## ğŸ“ ç¤ºä¾‹é€»è¾‘å›¾ï¼ˆé¡ºåºï¼‰

```
å¯åŠ¨æœŸï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ startupProbeâ”‚<â”€â”€â”€å¦‚æœå¤±è´¥ï¼Œå®¹å™¨è¢«æ€ï¼Œå…¶ä»–æ¢é’ˆä¸å·¥ä½œ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ æˆåŠŸåæ‰å¯ç”¨ä¸‹é¢ä¸¤ä¸ªæ¢é’ˆ
     â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ readinessProbeâ”‚<â”€â”€â”€å¤±è´¥ï¼šService ä¸ä¼šæŠŠæµé‡å¯¼è¿›æ¥
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ livenessProbeâ”‚<â”€â”€â”€å¤±è´¥ï¼šå®¹å™¨è¢«é‡å¯
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æ˜¯å¦å¯ä»¥ä¸‰ä¸ªä¸€èµ·ç”¨ï¼Ÿ

å½“ç„¶å¯ä»¥ï¼æ¨èé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```yaml
startupProbe:    # å¯åŠ¨å‰æœŸé˜²è¯¯æ€
readinessProbe:  # åº”ç”¨çœŸæ­£å¯ç”¨æ—¶æ‰æ¥æµé‡
livenessProbe:   # åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºé—®é¢˜å¯ä»¥è‡ªåŠ¨æ¢å¤
```

---

## ğŸ“¦ æ€»ç»“å»ºè®®

| ç±»å‹               | å»ºè®®æ˜¯å¦ä½¿ç”¨               | è¯´æ˜          |
| ---------------- | -------------------- | ----------- |
| `startupProbe`   | å¦‚æœä½ çš„åº”ç”¨å¯åŠ¨å¾ˆæ…¢ï¼ˆ>10sï¼‰å°±å»ºè®®ç”¨ | é˜²æ­¢è¯¯æ€        |
| `readinessProbe` | **å¼ºçƒˆå»ºè®®**ç”¨            | æµé‡åªç»™å°±ç»ªæœåŠ¡    |
| `livenessProbe`  | **å¼ºçƒˆå»ºè®®**ç”¨            | ä¿è¯è¿è¡Œä¸­ä¸ä¼šâ€œåƒµæ­»â€ |

---

å¦‚æœä½ å‘Šè¯‰æˆ‘ä½ çš„åº”ç”¨å¯åŠ¨å¤§æ¦‚è€—æ—¶ã€æ˜¯å¦åˆå§‹åŒ–ä¾èµ–è¾ƒå¤šï¼Œæˆ‘å¯ä»¥å¸®ä½ é…ç½®è¿™ä¸‰ç§æ¢é’ˆçš„æœ€ä¼˜ç»„åˆã€‚æ˜¯å¦éœ€è¦æˆ‘ä¸€èµ·åŠ å…¥åˆ°ä½ çš„ Deployment ä¸­ï¼Ÿ


# Reference